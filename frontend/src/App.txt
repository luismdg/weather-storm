import { useState, useEffect } from "react"
import RainmapSidebar from "./components/rainmap/RainMapSideBar"
import RainmapContent from "./components/rainmap/RainMapContent"
import DashboardSidebar from "./components/dashboard/DashboardSidebar"
import DashboardContent from "./components/dashboard/DashboardContent"

const API_BASE_URL = "http://localhost:8000"

// Funci√≥n para procesar los datos de tormentas
const processStormData = (data, imageDate) => {
  let storms = []
  
  Object.keys(data).forEach(key => {
    const storm = data[key];
    if (typeof storm === 'object' && storm.id) {
      
      let categoria = 1
      if (storm.storm_type && Array.isArray(storm.storm_type)) {
        const lastType = storm.storm_type[storm.storm_type.length - 1]
        if (lastType === "HU") categoria = 3
        else if (lastType === "TS") categoria = 2
        else if (lastType === "TD") categoria = 1
      }
      
      const imageUrl = imageDate
        ? `${API_BASE_URL}/api/date/${imageDate}/maps/${storm.id}/0?v=${imageDate}`
        : `${API_BASE_URL}/api/maps/${storm.id}?v=${Date.now()}`

      storms.push({
        id: storm.id,
        nombre: storm.name,
        name: storm.name,
        categoria: categoria,
        category: categoria,
        velocidad_viento: storm.max_wind || 0,
        windSpeed: storm.max_wind || 0,
        presion: storm.min_pressure || 0,
        pressure: storm.min_pressure || 0,
        ubicacion: storm.basin === "north_atlantic" ? "Atl√°ntico Norte" : 
                   storm.basin === "east_pacific" ? "Pac√≠fico Este" : 
                   storm.basin,
        location: storm.basin === "north_atlantic" ? "North Atlantic" : 
                  storm.basin === "east_pacific" ? "East Pacific" : 
                  storm.basin,
        year: storm.year,
        season: storm.season,
        ace: storm.ace,
        invest: storm.invest,
        storm_type: storm.storm_type,
        estado: storm.invest ? "watch" : "active",
        status: storm.invest ? "watch" : "active",
        imageUrl: imageUrl 
      })
    }
  })
  
  console.log("‚úÖ Tormentas procesadas:", storms)
  console.log(`üìä Total de tormentas: ${storms.length}`)
  return storms;
}

function App() {
  const [view, setView] = useState("map")
  const [selectedCity, setSelectedCity] = useState(null)
  const [weatherData, setWeatherData] = useState(null)
  const [mainStormView, setMainStormView] = useState(null)
  const [activeStorms, setActiveStorms] = useState([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState(null)
  const [latestDate, setLatestDate] = useState(null)

  // useEffect #1: Para el CALENDARIO (fechas hist√≥ricas)
  useEffect(() => {
    if (view === "dashboard" && latestDate) {
      setMainStormView(null);
      fetchStormsByDate(latestDate);
    }
  }, [latestDate])

  // useEffect #2: Para CAMBIAR DE VISTA (Carga inicial o Limpieza)
  useEffect(() => {
    if (view === "dashboard") {
      setMainStormView(null);
      if (!latestDate) {
        fetchLatestStorms();
      }
    } else {
      setLatestDate(null);
      setActiveStorms([]);
      setError(null);
    }
  }, [view])

  // Funci√≥n para el CALENDARIO (Hist√≥rico)
  const fetchStormsByDate = async (dateString) => {
    try {
      setLoading(true)
      setError(null)
      
      const response = await fetch(`${API_BASE_URL}/api/date/${dateString}/storms`)
      
      if (!response.ok) {
        if (response.status === 404) {
          throw new Error(`No se encontraron datos de tormentas para la fecha ${dateString}.`);
        }
        throw new Error('Error al conectar con el servidor.')
      }
      
      const data = await response.json()
      console.log(`üì¶ Datos COMPLETOS (${dateString}) recibidos:`, data)

      const stormsData = data.data || {};
      console.log(`üóÇÔ∏è stormsData bruto:`, stormsData)
      
      let actualStormsData = null;
      const tormentasKey = Object.keys(stormsData).find(key => 
        key.startsWith('tormentas') && typeof stormsData[key] === 'object'
      );
      
      if (tormentasKey) {
        actualStormsData = stormsData[tormentasKey];
        console.log(`‚úÖ Encontrado archivo: ${tormentasKey}`)
      }
      
      console.log(`üåÄ Datos de tormentas a procesar:`, actualStormsData)

      if (!actualStormsData || Object.keys(actualStormsData).length === 0) {
        setActiveStorms([])
        console.log(`‚ö†Ô∏è No hay tormentas activas para la fecha ${dateString}.`);
      } else {
        console.log(`üîë Claves de tormentas encontradas:`, Object.keys(actualStormsData))
        const storms = processStormData(actualStormsData, dateString);
        setActiveStorms(storms)
      }
      
    } catch (err) {
      console.error(`‚ùå Error fetching storms for date ${dateString}:`, err)
      setError(err.message) 
      setActiveStorms([]) 
    } finally {
      setLoading(false)
    }
  }

  // Funci√≥n para la "√öltima Lectura"
  const fetchLatestStorms = async () => {
    try {
      setLoading(true)
      setError(null)
      
      console.log(`üïê Cargando √öLTIMA LECTURA...`)
      const response = await fetch(`${API_BASE_URL}/api/storms`, { cache: 'no-store' })
      
      if (!response.ok) {
        throw new Error('No se pudieron cargar los datos de tormentas')
      }
      
      const data = await response.json()
      console.log("üì¶ Datos (√öLTIMA LECTURA) recibidos:", data)
      
      const storms = processStormData(data, null);
      setActiveStorms(storms)
      
    } catch (err) {
      console.error('‚ùå Error fetching latest storms:', err)
      setError(err.message)
      setActiveStorms([])
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="flex min-h-screen bg-rainmap-bg text-rainmap-contrast overflow-hidden">
      <div className="w-80 border-r border-rainmap-glass-border/30">
        {view === "map" ? (
          <RainmapSidebar
            view={view}
            setView={setView}
            selectedCity={selectedCity}
            setSelectedCity={setSelectedCity}
            weatherData={weatherData}
            setWeatherData={setWeatherData}
          />
        ) : (
          <DashboardSidebar 
            view={view} 
            setView={setView} 
            mainStormView={mainStormView}
            activeStorms={activeStorms}
            activeDate={latestDate}
            onDateChange={setLatestDate}
          />
        )}
      </div>

      <div className="flex-1">
        {view === "map" ? (
          <RainmapContent selectedCity={selectedCity} />
        ) : (
          <DashboardContent 
            mainStormView={mainStormView} 
            setMainStormView={setMainStormView}
            activeStorms={activeStorms}
            loading={loading}
            error={error}
            latestDate={latestDate}
          />
        )}
      </div>
    </div>
  )
}

export default App